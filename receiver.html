<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Receiver Dashboard - Waste Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-5">
    <h2 class="text-center mb-4">ðŸš› Receiver Dashboard</h2>

    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white">Pending Requests</div>
      <div class="card-body" id="receiverRequests">
        <p class="text-muted">No pending requests.</p>
      </div>
    </div>

  </div>

  <script>
  const API_URL = "http://localhost/project/backend.php";
  const receiverRequests = document.getElementById('receiverRequests');

  async function loadReceiverRequests() {
    const res = await fetch(`${API}?role=receiver`);
    const data = await res.json();
    receiverRequests.innerHTML = '';
    if (!data || data.length === 0) {
      receiverRequests.innerHTML = '<p class="text-muted">No pending requests.</p>';
      return;
    }

    data.forEach(r => {
      const card = document.createElement('div');
      card.className = 'card mb-3 shadow-sm';
      card.innerHTML = `
        <div class="card-body">
          <h5 class="card-title">Request #${r.id}</h5>
          <p class="card-text"><b>User:</b> ${r.user_name}</p>
          <p class="card-text"><b>Waste Type:</b> ${r.waste_type}</p>
          <p class="card-text"><b>Location:</b> ${r.location}</p>
          <p class="card-text"><small class="text-muted">Created At: ${r.created_at}</small></p>
        </div>`;

      const acceptBtn = document.createElement('button');
      acceptBtn.className = 'btn btn-success btn-sm m-2';
      acceptBtn.textContent = 'Mark Completed';
      acceptBtn.onclick = () => markCompleted(r.id);

      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'btn btn-danger btn-sm m-2';
      cancelBtn.textContent = 'Cancel Request';
      cancelBtn.onclick = () => cancelByReceiver(r.id);

      card.querySelector('.card-body').appendChild(acceptBtn);
      card.querySelector('.card-body').appendChild(cancelBtn);

      receiverRequests.appendChild(card);
    });
  }

  async function markCompleted(id) {
    const fd = new FormData();
    fd.append('action','complete');
    fd.append('id', id);
    const res = await fetch(API, { method: 'POST', body: fd });
    const json = await res.json();
    if (json.success) {
      alert(json.message);
      loadReceiverRequests();
    } else {
      alert(json.error || 'Error marking complete');
    }
  }

  async function cancelByReceiver(id) {
    const fd = new FormData();
    fd.append('action','cancel');
    fd.append('id', id);
    const res = await fetch(API, { method: 'POST', body: fd });
    const json = await res.json();
    if (json.success) {
      alert(json.message);
      loadReceiverRequests();
    } else {
      alert(json.error || 'Error cancelling');
    }
  }

  loadReceiverRequests();
  // Poll every 10 seconds to keep updated
  setInterval(loadReceiverRequests, 10000);
  </script>
</body>
</html>
